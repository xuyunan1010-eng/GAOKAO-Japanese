<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥è¯­è¯•å·è¯é¢‘åˆ†æå·¥å…·ï¼ˆæœ¬åœ°åŠ é€Ÿç‰ˆï¼‰</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; font-family: -apple-system, sans-serif; background: #f0f4f8; color: #333; line-height: 1.6; }
        header { background: #2563eb; color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        main { display: grid; grid-template-columns: 1fr 300px; gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .panel { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .upload-zone { border: 2px dashed #3b82f6; border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { background: #eff6ff; }
        #status { font-weight: bold; margin: 15px 0; padding: 10px; border-radius: 6px; }
        .status-loading { background: #fef3c7; color: #92400e; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #b91c1c; }
        .word-tag { display: inline-block; background: #f1f5f9; padding: 6px 12px; margin: 4px; border-radius: 20px; font-size: 14px; cursor: pointer; border: 1px solid #e2e8f0; }
        .word-tag:hover { background: #3b82f6; color: white; }
        .count { font-size: 11px; opacity: 0.6; margin-left: 5px; }
        h3 { border-left: 4px solid #3b82f6; padding-left: 10px; margin-top: 25px; }
        .vocab-item { padding: 8px; border-bottom: 1px solid #f1f5f9; font-size: 14px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { main { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>æ—¥è¯­è¯•å·è¯é¢‘æå–å·¥å…· ğŸ”</h1>
</header>

<main>
    <section class="panel">
        <div id="status" class="status-loading">æ­£åœ¨å°è¯•ä»æœ¬åœ°åŠ è½½å­—å…¸å¼•æ“...</div>
        
        <label class="upload-zone" for="fileInput" id="dropArea">
            <big>ğŸ“„ ç‚¹å‡»æ­¤å¤„ä¸Šä¼  Word (.docx) è¯•å·</big>
            <p style="color: #64748b;">æ”¯æŒè‡ªåŠ¨åˆ†è¯ã€è¯å½¢è¿˜åŸã€æŒ‰è¯æ€§åˆ†ç±»</p>
        </label>
        <input type="file" id="fileInput" accept=".docx" hidden>

        <div id="result"></div>
    </section>

    <aside class="panel">
        <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
        <div id="vocabList"></div>
        <button id="clearVocab" style="margin-top:20px; font-size:12px; color:#94a3b8; background:none; border:none; cursor:pointer;">æ¸…ç©ºåˆ—è¡¨</button>
    </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

<script>
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const vocabListEl = document.getElementById('vocabList');
    const fileInput = document.getElementById('fileInput');
    let tokenizer = null;
    const vocabSet = new Set();

    // 1. åˆå§‹åŒ–åˆ†è¯å™¨ï¼ˆä½¿ç”¨æœ¬åœ°è·¯å¾„ï¼‰
    console.log("æ­£åœ¨åˆå§‹åŒ–...");
    kuromoji.builder({ dicPath: "dict/" }).build((err, _tokenizer) => {
        if (err) {
            statusEl.className = 'status-error';
            statusEl.innerHTML = `âŒ å¼•æ“å¯åŠ¨å¤±è´¥ï¼<br><small>è¯·ç¡®ä¿æ˜¯é€šè¿‡ http://localhost è®¿é—®ï¼Œä¸”æ–‡ä»¶å¤¹å†…æœ‰ dict ç›®å½•ã€‚</small>`;
            console.error(err);
        } else {
            tokenizer = _tokenizer;
            statusEl.className = 'status-ready';
            statusEl.textContent = "âœ… æœ¬åœ°å¼•æ“å·²å°±ç»ªï¼Œè¯·ä¸Šä¼ æ–‡ä»¶ã€‚";
        }
    });

    // 2. ç›‘å¬æ–‡ä»¶ä¸Šä¼ 
    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file || !tokenizer) return;

        statusEl.textContent = "æ­£åœ¨è¯»å– Word æ–‡æ¡£å†…å®¹...";
        try {
            const arrayBuffer = await file.arrayBuffer();
            const { value } = await mammoth.extractRawText({ arrayBuffer });
            
            statusEl.textContent = "æ­£åœ¨è¿›è¡Œæ—¥è¯­è¯­è¨€åˆ†æ...";
            
            // ä½¿ç”¨ setTimeout å¼‚æ­¥å¤„ç†ï¼Œé˜²æ­¢ UI ç¬é—´å¡æ­»
            setTimeout(() => {
                const tokens = tokenizer.tokenize(value);
                processAndRender(tokens);
            }, 50);

        } catch (err) {
            statusEl.className = 'status-error';
            statusEl.textContent = "âŒ è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚";
        }
    });

    // 3. å¤„ç†åˆ†è¯æ•°æ®
    function processAndRender(tokens) {
        const data = { 'åè¯': {}, 'åŠ¨è¯': {}, 'å½¢å®¹è¯': {} };
        
        tokens.forEach(t => {
            let category = null;
            if (t.pos === 'åè©') category = 'åè¯';
            else if (t.pos === 'å‹•è©') category = 'åŠ¨è¯';
            else if (t.pos === 'å½¢å®¹è©') category = 'å½¢å®¹è¯';

            if (category) {
                // ä¼˜å…ˆä½¿ç”¨è¯æºå½¢æ€ï¼ˆè¿˜åŸåŠ¨è¯åŸå‹ï¼‰
                const word = t.basic_form !== '*' ? t.basic_form : t.surface_form;
                
                // ç®€å•è¿‡æ»¤ï¼šè¿‡æ»¤æ‰é•¿åº¦ä¸º1çš„éæ±‰å­—è¯ï¼ˆå¦‚ï¼šã¦ã€ã«ã€ã‚’ã€ã¯ï¼‰
                if (word.length < 2 && !/[\u4E00-\u9FFF]/.test(word)) return;
                
                data[category][word] = (data[category][word] || 0) + 1;
            }
        });

        renderHTML(data);
    }

    // 4. æ¸²æŸ“ç»“æœ
    function renderHTML(data) {
        resultEl.innerHTML = '';
        statusEl.textContent = "âœ… åˆ†æå®Œæˆï¼ç‚¹å‡»å•è¯å¯åŠ å…¥ç”Ÿè¯æœ¬ã€‚";

        for (const cat in data) {
            if (Object.keys(data[cat]).length === 0) continue;

            const h3 = document.createElement('h3');
            h3.textContent = cat;
            resultEl.appendChild(h3);

            // æŒ‰é¢‘æ¬¡æ’åº
            const sortedWords = Object.entries(data[cat]).sort((a, b) => b[1] - a[1]);
            
            sortedWords.forEach(([word, freq]) => {
                const span = document.createElement('span');
                span.className = 'word-tag';
                span.innerHTML = `${word} <span class="count">${freq}</span>`;
                span.onclick = () => addToVocab(word);
                resultEl.appendChild(span);
            });
        }
    }

    // 5. ç”Ÿè¯æœ¬åŠŸèƒ½
    function addToVocab(word) {
        if (vocabSet.has(word)) return;
        vocabSet.add(word);
        
        const div = document.createElement('div');
        div.className = 'vocab-item';
        div.textContent = `â€¢ ${word}`;
        vocabListEl.prepend(div); // æ–°åŠ çš„è¯åœ¨æœ€ä¸Šé¢
    }

    document.getElementById('clearVocab').onclick = () => {
        vocabSet.clear();
        vocabListEl.innerHTML = '';
    };
</script>

</body>
</html>
