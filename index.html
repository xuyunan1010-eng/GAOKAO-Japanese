<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ—¥è¯­è¾ä¹¦å½¢æå–å·¥å…· (é˜²å¡æ­»ç‰ˆ)</title>
<style>
  body { font-family: "Hiragino Kaku Gothic ProN", sans-serif; padding: 30px; background: #f8fafc; color: #334155; }
  .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  h2 { border-bottom: 2px solid #3b82f6; padding-bottom: 10px; color: #1e293b; }
  
  /* çŠ¶æ€æ æ ·å¼ */
  .status-bar { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 14px; transition: 0.3s; }
  .status-init { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
  .status-ready { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
  
  .upload-btn {
    display: block; width: 100%; padding: 20px; border: 2px dashed #cbd5e1; border-radius: 8px;
    background: #f1f5f9; text-align: center; cursor: not-allowed; color: #94a3b8; transition: 0.2s;
  }
  .upload-btn.active { cursor: pointer; background: #eff6ff; border-color: #3b82f6; color: #2563eb; }
  .upload-btn.active:hover { background: #dbeafe; }

  .result-box { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .col h3 { font-size: 16px; background: #e2e8f0; padding: 8px; border-radius: 4px; }
  
  .word-item { 
    display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding: 6px 0; font-size: 15px; 
  }
  .base-form { color: #2563eb; font-weight: bold; } /* è¾ä¹¦å½¢é¢œè‰² */
  .pos-tag { font-size: 12px; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ‡¯ğŸ‡µ æ—¥è¯­è¾ä¹¦å½¢åˆ†æå™¨ (Web Worker)</h2>
  
  <div id="status" class="status-bar status-init">
    â³ æ­£åœ¨åå°å¯åŠ¨åˆ†æå¼•æ“ (ä¸‹è½½è¯åº“ä¸­)...<br>
    <small style="font-weight:normal">ç¬¬ä¸€æ¬¡åŠ è½½éœ€è¦ 10-20 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼Œä¸ä¼šå¡æ­»æµè§ˆå™¨ã€‚</small>
  </div>

  <label id="dropZone" class="upload-btn">
    ç­‰å¾…å¼•æ“å°±ç»ª...
    <input type="file" id="fileInput" accept=".docx" hidden disabled>
  </label>

  <div id="output" class="result-box">
    <div class="col" id="verbs"><h3>åŠ¨è¯ (è‡ªåŠ¨è¿˜åŸè¾ä¹¦å½¢)</h3><div></div></div>
    <div class="col" id="nouns"><h3>åè¯ / å½¢å®¹è¯</h3><div></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

<script>
  const statusEl = document.getElementById('status');
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  // --- å®šä¹‰ Worker ä»£ç  (åœ¨åå°è¿è¡Œçš„è„šæœ¬) ---
  const workerCode = `
    importScripts("https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js");

    let tokenizer = null;

    // ç›‘å¬ä¸»çº¿ç¨‹å‘æ¥çš„æ¶ˆæ¯
    self.onmessage = function(e) {
      if (e.data.type === 'init') {
        // åˆå§‹åŒ–è¯åº“
        kuromoji.builder({ dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/" })
          .build(function(err, _tokenizer) {
            if (err) {
              self.postMessage({ type: 'error', msg: err.message });
            } else {
              tokenizer = _tokenizer;
              self.postMessage({ type: 'ready' });
            }
          });
      } else if (e.data.type === 'analyze') {
        // å¼€å§‹åˆ†ææ–‡æœ¬
        if (!tokenizer) return;
        const tokens = tokenizer.tokenize(e.data.text);
        
        // æå–ç»“æœï¼Œåªè¿”å›å¿…è¦æ•°æ®ä»¥èŠ‚çœå†…å­˜
        const results = tokens.map(t => ({
          surface: t.surface_form,   // åŸæ–‡ (å¦‚: å™›ã¾ã‚Œã¾ã—ãŸ)
          base: t.basic_form,        // è¾ä¹¦å½¢ (å¦‚: å™›ã‚€)
          pos: t.pos,                // è¯æ€§ (å¦‚: å‹•è©)
          pos_detail: t.pos_detail_1 // è¯¦ç»†è¯æ€§
        }));
        
        self.postMessage({ type: 'result', data: results });
      }
    };
  `;

  // --- ä¸»çº¿ç¨‹é€»è¾‘ ---
  
  // 1. åˆ›å»º Worker
  const blob = new Blob([workerCode], { type: 'application/javascript' });
  const worker = new Worker(URL.createObjectURL(blob));

  // 2. å¯åŠ¨ Worker
  worker.postMessage({ type: 'init' });

  // 3. ç›‘å¬ Worker è¿”å›çš„æ¶ˆæ¯
  worker.onmessage = function(e) {
    const msg = e.data;

    if (msg.type === 'ready') {
      statusEl.className = 'status-bar status-ready';
      statusEl.textContent = 'âœ… å¼•æ“å·²å°±ç»ªï¼(è¾ä¹¦å½¢è¿˜åŸåŠŸèƒ½å¯ç”¨)';
      dropZone.className = 'upload-btn active';
      dropZone.childNodes[0].nodeValue = 'ğŸ“‚ ç‚¹å‡»ä¸Šä¼  Word è¯•å· (.docx)';
      fileInput.disabled = false;
    } 
    else if (msg.type === 'error') {
      statusEl.textContent = 'âŒ åŠ è½½å¤±è´¥: ' + msg.msg;
      statusEl.style.background = '#fee2e2';
    }
    else if (msg.type === 'result') {
      render(msg.data);
      statusEl.textContent = 'âœ… åˆ†æå®Œæˆï¼';
    }
  };

  // 4. å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  fileInput.addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (!file) return;

    statusEl.textContent = 'âŒ› æ­£åœ¨è¯»å–æ–‡æ¡£...';
    try {
      const buffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer: buffer });
      
      statusEl.textContent = 'âš¡ æ­£åœ¨åå°è¿›è¡Œè¯­æ³•åˆ†æ (è¿˜åŸè¾ä¹¦å½¢)...';
      // å‘é€ç»™åå°çº¿ç¨‹å¤„ç†
      worker.postMessage({ type: 'analyze', text: result.value });
      
    } catch (err) {
      statusEl.textContent = 'âŒ æ–‡ä»¶è¯»å–é”™è¯¯';
    }
  });

  // 5. æ¸²æŸ“ç»“æœ
  function render(tokens) {
    const verbs = {};
    const nouns = {};

    tokens.forEach(t => {
      // æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæœ‰ basic_form (è¾ä¹¦å½¢) ä¸”ä¸æ˜¯ *ï¼Œå°±ç”¨è¾ä¹¦å½¢ï¼›å¦åˆ™ç”¨åŸæ–‡
      const dictForm = (t.base && t.base !== '*') ? t.base : t.surface;

      if (t.pos === 'å‹•è©') {
        // è¿‡æ»¤æ‰éè‡ªç«‹åŠ¨è¯ (å¦‚: ã„ã‚‹ã€ã‚ã‚‹ã€ãªã‚‹ ç­‰è¾…åŠ©åŠ¨è¯ï¼Œè§†éœ€æ±‚è€Œå®š)
        if (t.pos_detail !== 'éè‡ªç«‹') {
           verbs[dictForm] = (verbs[dictForm] || 0) + 1;
        }
      } else if (t.pos === 'åè©' && t.pos_detail === 'ä¸€èˆ¬') {
         nouns[dictForm] = (nouns[dictForm] || 0) + 1;
      } else if (t.pos === 'å½¢å®¹è©') {
         nouns[dictForm] = (nouns[dictForm] || 0) + 1; // æš‚æ—¶æ”¾åœ¨å³æ 
      }
    });

    displayList('verbs', verbs);
    displayList('nouns', nouns);
  }

  function displayList(id, data) {
    const container = document.querySelector(`#${id} div`);
    container.innerHTML = '';
    
    // æŒ‰è¯é¢‘æ’åº
    const sorted = Object.entries(data).sort((a,b) => b[1] - a[1]).slice(0, 100);
    
    sorted.forEach(([word, count]) => {
      const div = document.createElement('div');
      div.className = 'word-item';
      div.innerHTML = `
        <span class="base-form">${word}</span>
        <span style="color:#64748b">x ${count}</span>
      `;
      container.appendChild(div);
    });
  }
</script>

</body>
</html>
