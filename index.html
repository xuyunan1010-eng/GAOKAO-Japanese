<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥æœ¬èªãƒ†ã‚¹ãƒˆèªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ«ğŸ”</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 30px; background: #f8fafc; color: #333; }
        .box { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 15px; background: #cbd5e1; color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: not-allowed; margin-top: 20px; }
        .btn.active { background: #2563eb; cursor: pointer; }
        .btn-export { background: #10b981 !important; display: none; margin-top: 10px; }
        #log { margin-top: 15px; padding: 10px; background: #1e293b; color: #4ade80; font-family: monospace; font-size: 12px; border-radius: 6px; min-height: 80px; overflow-y: auto; }
        .error-log { color: #f87171 !important; }
        
        /* åˆ†ç±»æ¿å—æ ·å¼ */
        .result-columns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 25px; }
        .column { background: #f1f5f9; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 500px; overflow-y: auto; }
        .column h4 { margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #cbd5e1; color: #1e293b; position: sticky; top: 0; background: #f1f5f9; }
        .word-tag { display: flex; justify-content: space-between; background: white; padding: 4px 8px; margin: 4px 0; border-radius: 4px; font-size: 14px; border: 1px solid #e2e8f0; }
        .count-num { color: #64748b; font-size: 12px; }
    </style>
</head>
<body>

<div class="box">
    <h3>æ—¥æœ¬èªãƒ†ã‚¹ãƒˆèªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ«ğŸ”</h3>
    <div id="log">æ­£åœ¨è¿æ¥è¯Šæ–­ç³»ç»Ÿ...</div>
    
    <input type="file" id="fileInput" accept=".docx" style="display:none">
    <button id="mainBtn" class="btn">ç­‰å¾…å¼•æ“åŠ è½½...</button>
    <button id="exportBtn" class="btn btn-export active">ğŸ“Š å¯¼å‡ºä¸º Excel è¡¨æ ¼</button>
    
    <div id="result" class="result-columns"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

<script>
    const logEl = document.getElementById('log');
    const btn = document.getElementById('mainBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resultDiv = document.getElementById('result');
    let myWorker = null;
    let lastAnalysisData = null; // å­˜å‚¨åˆ†æç»“æœç”¨äºå¯¼å‡º

    function log(msg, isError = false) {
        logEl.innerHTML += `<div>${isError ? 'âŒ ' : '> '}${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
        if (isError) logEl.classList.add('error-log');
    }

    // 1. é¢„å…ˆæ£€æŸ¥
    fetch('dict/base.dat.gz', { method: 'HEAD' })
        .then(resp => {
            if (resp.ok) {
                log("æ£€æµ‹åˆ°æœ¬åœ°å­—å…¸æ–‡ä»¶ï¼Œå‡†å¤‡å¯åŠ¨å¼•æ“...");
                initWorker();
            } else {
                throw new Error(`æ‰¾ä¸åˆ°å­—å…¸æ–‡ä»¶ (çŠ¶æ€ç : ${resp.status})`);
            }
        })
        .catch(err => {
            log("ä¸¥é‡é”™è¯¯ï¼šæ— æ³•è¯»å– dict æ–‡ä»¶å¤¹ï¼", true);
        });

    // 2. åˆå§‹åŒ– Worker
    function initWorker() {
        const workerScript = `
            importScripts("https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js");
            self.onmessage = function(e) {
                if (e.data.type === 'init') {
                    kuromoji.builder({ dicPath: "dict/" }).build((err, tokenizer) => {
                        if (err) self.postMessage({ type: 'error', msg: err.message });
                        else {
                            self.tokenizer = tokenizer;
                            self.postMessage({ type: 'ready' });
                        }
                    });
                } else if (e.data.type === 'parse') {
                    if (!self.tokenizer) return;
                    const tokens = self.tokenizer.tokenize(e.data.text);
                    const result = tokens
                        .filter(t => ['åè©','å‹•è©','å½¢å®¹è©'].includes(t.pos))
                        .map(t => ({
                            word: (t.basic_form === '*' ? t.surface_form : t.basic_form),
                            pos: t.pos
                        }));
                    self.postMessage({ type: 'result', data: result });
                }
            };
        `;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        myWorker = new Worker(URL.createObjectURL(blob));
        myWorker.onmessage = function(e) {
            if (e.data.type === 'ready') {
                log("âœ… å¼•æ“åŠ è½½æˆåŠŸï¼");
                btn.className = "btn active";
                btn.textContent = "ğŸ“‚ ç‚¹å‡»ä¸Šä¼  Word è¯•å·å¹¶åˆ†æ";
                btn.onclick = () => document.getElementById('fileInput').click();
            } else if (e.data.type === 'result') {
                lastAnalysisData = e.data.data;
                renderResult(e.data.data);
                exportBtn.style.display = 'block'; // æ˜¾ç¤ºå¯¼å‡ºæŒ‰é’®
            }
        };
        log("æ­£åœ¨åå°è§£å‹å­—å…¸...");
        myWorker.postMessage({ type: 'init' });
    }

    // 3. å¤„ç†æ–‡ä»¶
    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        log("å¼€å§‹åˆ†ææ–‡æœ¬æ–‡æ¡£...");
        const buffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: buffer });
        myWorker.postMessage({ type: 'parse', text: result.value });
    };

    // 4. æ¸²æŸ“ç•Œé¢
    function renderResult(items) {
        const categories = { 'å‹•è©': {}, 'åè©': {}, 'å½¢å®¹è©': {} };
        items.forEach(item => {
            if (item.word.length > 1 || /[\u4E00-\u9FFF]/.test(item.word)) {
                if (categories[item.pos]) categories[item.pos][item.word] = (categories[item.pos][item.word] || 0) + 1;
            }
        });

        resultDiv.innerHTML = '';
        const titles = { 'å‹•è©': 'ğŸ”¹ åŠ¨è¯', 'åè©': 'ğŸ”¸ åè¯', 'å½¢å®¹è©': 'ğŸŒ¿ å½¢å®¹è¯' };
        for (const [pos, words] of Object.entries(categories)) {
            const sorted = Object.entries(words).sort((a,b) => b[1] - a[1]);
            let columnHtml = `<div class="column"><h4>${titles[pos]} (${sorted.length})</h4>`;
            sorted.slice(0, 100).forEach(([w, c]) => {
                columnHtml += `<div class="word-tag"><span>${w}</span><span class="count-num">${c}æ¬¡</span></div>`;
            });
            columnHtml += `</div>`;
            resultDiv.innerHTML += columnHtml;
        }
        log("âœ… åˆ†æå®Œæˆï¼");
    }

    // 5. Excel å¯¼å‡ºæ ¸å¿ƒåŠŸèƒ½
    exportBtn.onclick = function() {
        if (!lastAnalysisData) return;
        log("æ­£åœ¨ç”Ÿæˆ Excel æ–‡ä»¶...");

        const wb = XLSX.utils.book_new(); // åˆ›å»ºå·¥ä½œç°¿
        const catMap = { 'å‹•è©': 'åŠ¨è¯', 'åè©': 'åè¯', 'å½¢å®¹è©': 'å½¢å®¹è¯' };
        
        Object.entries(catMap).forEach(([posKey, sheetName]) => {
            // è¿‡æ»¤å¹¶ç»Ÿè®¡è¯é¢‘
            const counts = {};
            lastAnalysisData.filter(i => i.pos === posKey).forEach(i => {
                if (i.word.length > 1 || /[\u4E00-\u9FFF]/.test(i.word)) {
                    counts[i.word] = (counts[i.word] || 0) + 1;
                }
            });

            // è½¬æ¢æˆ Excel éœ€è¦çš„æ•°ç»„æ ¼å¼å¹¶æ’åº
            const data = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .map(([word, count]) => ({ "å•è¯ (è¾ä¹¦å½¢)": word, "å‡ºç°é¢‘ç‡": count }));

            // åˆ›å»º Sheet å¹¶æ·»åŠ åˆ°å·¥ä½œç°¿
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
        });

        // è§¦å‘ä¸‹è½½
        XLSX.writeFile(wb, "æ—¥è¯­è¯•å·è¯é¢‘åˆ†æç»“æœ.xlsx");
        log("ğŸ’¾ Excel æ–‡ä»¶å¯¼å‡ºæˆåŠŸï¼");
    };
</script>
</body>
</html>
