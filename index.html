<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", sans-serif;
  background: #ffffff;
  color: #222;
}
header {
  padding: 16px 24px;
  border-bottom: 1px solid #e5e7eb;
  background: #f8fbff;
}
header h1 {
  margin: 0;
  font-size: 20px;
  color: #2563eb;
}
main {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 16px;
  padding: 16px 24px;
}
.panel {
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.04);
  padding: 16px;
}
.upload-area {
  border: 2px dashed #93c5fd;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  color: #2563eb;
  cursor: pointer;
}
.word-card {
  display: inline-block;
  margin: 4px;
  padding: 6px 10px;
  border-radius: 8px;
  background: #f9fafb;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.freq {
  font-size: 12px;
  color: #6b7280;
}
h3 {
  margin: 16px 0 8px;
  color: #2563eb;
}
</style>
</head>

<body>
<header>
  <h1>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·</h1>
</header>

<main>
<section class="panel">
  <label class="upload-area" for="fileInput">
    ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ—¥è¯­è¯•å·å›¾ç‰‡ / Word æ–‡æ¡£
  </label>
  <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.docx" hidden>

  <div id="status" style="margin-top:12px;color:#6b7280"></div>

  <!-- è¿›åº¦æ¡ -->
  <div id="progressBox" style="margin-top:8px; display:none;">
    <div style="height:8px;background:#e5e7eb;border-radius:4px;">
      <div id="progressBar"
           style="height:8px;width:0%;background:#60a5fa;border-radius:4px;transition:width 0.3s;">
      </div>
    </div>
  </div>

  <div id="wordList"></div>
</section>

<aside class="panel">
  <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
  <div id="vocabBook"></div>
</aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const wordListEl = document.getElementById("wordList");
const vocabBookEl = document.getElementById("vocabBook");
const progressBox = document.getElementById("progressBox");
const progressBar = document.getElementById("progressBar");
const vocabSet = new Set();

fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if (!file) return;

  statusEl.textContent = "æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™â€¦";
  wordListEl.innerHTML = "";
  progressBox.style.display = "block";
  progressBar.style.width = "20%";

  let text = "";

  if (file.type.includes("image")) {
    const result = await Tesseract.recognize(file, "jpn");
    text = result.data.text;
  } else if (file.name.endsWith(".docx")) {
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    text = result.value;
  }

  progressBar.style.width = "60%";
  analyzeJapanese(text);
});

function analyzeJapanese(text) {
  kuromoji.builder({
    dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/"
  }).build((err, tokenizer) => {
    if (err) {
      statusEl.textContent = "åˆ†è¯å™¨åŠ è½½å¤±è´¥";
      return;
    }

    progressBar.style.width = "80%";

    const result = {
      åŠ¨è¯: {},
      åè¯: {},
      å½¢å®¹è¯: {}
    };

    tokenizer.tokenize(text).forEach(t => {
      const base = t.basic_form !== "*" ? t.basic_form : t.surface_form;
      let cat = null, sub = null;

      if (t.pos === "å‹•è©") {
        cat = "åŠ¨è¯";
        if (t.conjugated_type?.includes("äº”æ®µ")) sub = "ä¸€ç±»åŠ¨è¯ï¼ˆäº”æ®µï¼‰";
        else if (t.conjugated_type?.includes("ä¸€æ®µ")) sub = "äºŒç±»åŠ¨è¯ï¼ˆä¸€æ®µï¼‰";
        else if (base === "ã™ã‚‹") sub = "ä¸‰ç±»åŠ¨è¯ï¼ˆã‚µå˜ï¼‰";
        else if (base === "æ¥ã‚‹") sub = "ä¸‰ç±»åŠ¨è¯ï¼ˆã‚«å˜ï¼‰";
        else sub = "å…¶ä»–";
      }

      else if (t.pos === "åè©") {
        cat = "åè¯";
        if (t.pos_detail_1 === "æ•°") sub = "é‡è¯";
        else if (/^[ã‚¡-ãƒ¶ãƒ¼]+$/.test(t.surface_form)) sub = "ç‰‡å‡ååè¯";
        else if (["ä¸Š","ä¸‹","å‰","å¾Œ","ä¸­","å¤–","å³","å·¦","æ±","è¥¿","å—","åŒ—"].includes(base)) sub = "æ–¹ä½åè¯";
        else if (t.pos_detail_1 === "ä¸€èˆ¬") sub = "æ™®é€šåè¯";
        else sub = "å…¶ä»–";
      }

      else if (t.pos === "å½¢å®¹è©") {
        cat = "å½¢å®¹è¯";
        if (t.conjugated_type?.includes("ã‚¤")) sub = "ä¸€ç±»å½¢å®¹è¯";
        else sub = "äºŒç±»å½¢å®¹è¯";
      }

      if (!cat) return;
      if (!result[cat][sub]) result[cat][sub] = {};
      result[cat][sub][base] = (result[cat][sub][base] || 0) + 1;
    });

    progressBar.style.width = "100%";
    setTimeout(() => progressBox.style.display = "none", 500);

    render(result);
    statusEl.textContent = "è§£æå®Œæˆ";
  });
}

function render(data) {
  wordListEl.innerHTML = "";
  Object.entries(data).forEach(([cat, subs]) => {
    const h = document.createElement("h3");
    h.textContent = cat;
    wordListEl.appendChild(h);

    Object.entries(subs).forEach(([sub, words]) => {
      const s = document.createElement("div");
      s.innerHTML = `<strong>${sub}</strong>`;
      wordListEl.appendChild(s);

      Object.entries(words)
        .sort((a,b)=>b[1]-a[1])
        .forEach(([w,f]) => {
          const d = document.createElement("div");
          d.className = "word-card";
          d.innerHTML = `${w}<div class="freq">å‡ºç° ${f} æ¬¡</div>`;
          d.onclick = () => addVocab(w);
          wordListEl.appendChild(d);
        });
    });
  });
}

function addVocab(word) {
  if (vocabSet.has(word)) return;
  vocabSet.add(word);
  const d = document.createElement("div");
  d.textContent = word;
  vocabBookEl.appendChild(d);
}

});
</script>
</body>
</html>
