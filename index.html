<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·ï¼ˆä¿®å¤ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ... ä¿æŒæ‚¨çš„ CSS ä¸å˜ ... */
    body { margin: 0; font-family: sans-serif; background: #fff; color: #222; }
    header { padding: 16px 24px; border-bottom: 1px solid #e5e7eb; background: #f8fbff; }
    header h1 { margin: 0; font-size: 20px; color: #2563eb; }
    main { display: grid; grid-template-columns: 1fr 320px; gap: 16px; padding: 16px 24px; }
    .panel { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.04); padding: 16px; border: 1px solid #eee; }
    .upload-area { border: 2px dashed #93c5fd; border-radius: 12px; padding: 24px; display: block; text-align: center; color: #2563eb; cursor: pointer; }
    .word-section h3 { margin-top: 20px; color: #1d4ed8; border-bottom: 2px solid #eff6ff; }
    .sub-title { margin: 12px 0 6px; font-weight: bold; color: #4b5563; }
    .word-card { display: inline-block; margin: 4px; padding: 6px 10px; background: #f9fafb; border-radius: 6px; cursor: pointer; font-size: 14px; border: 1px solid #f0f0f0; }
    .word-card:hover { background: #eff6ff; border-color: #3b82f6; }
    .freq { font-size: 12px; color: #9ca3af; }
    .vocab-item { font-size: 14px; padding: 4px 8px; background: #f3f4f6; margin-bottom: 4px; border-radius: 4px; }
  </style>
</head>

<body>
<header><h1>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·ğŸ”</h1></header>

<main>
  <section class="panel">
    <label class="upload-area" for="fileInput" id="dropZone">ç‚¹å‡»ä¸Šä¼  Wordï¼ˆ.docxï¼‰</label>
    <input type="file" id="fileInput" accept=".docx" hidden />
    <div id="status" style="margin-top:10px; font-weight: bold;">æ­£åœ¨åˆå§‹åŒ–åˆ†è¯å¼•æ“ï¼Œè¯·ç¨å€™...</div>
    <div id="wordList"></div>
  </section>
  <aside class="panel">
    <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
    <div id="vocabBook"></div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

<script>
const statusEl = document.getElementById('status');
const wordListEl = document.getElementById('wordList');
const vocabBookEl = document.getElementById('vocabBook');
const vocabSet = new Set();
let kuromojiTokenizer = null;

// 1. é¡µé¢åŠ è½½å³åˆå§‹åŒ–åˆ†è¯å™¨ (æå‰ä¸‹è½½å­—å…¸)
kuromoji.builder({
  dicPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/'
}).build((err, tokenizer) => {
  if (err) {
    statusEl.textContent = 'âŒ åˆ†è¯å¼•æ“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢';
    console.error(err);
  } else {
    kuromojiTokenizer = tokenizer;
    statusEl.textContent = 'âœ… ç³»ç»Ÿå°±ç»ªï¼Œè¯·ä¸Šä¼ æ–‡ä»¶';
    statusEl.style.color = 'green';
  }
});

document.getElementById('fileInput').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file || !kuromojiTokenizer) return;

  statusEl.textContent = 'æ­£åœ¨è¯»å– Word æ–‡æ¡£...';
  try {
    const buffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: buffer });
    statusEl.textContent = 'æ­£åœ¨åˆ†æè¯é¢‘...';
    
    // ä½¿ç”¨ setTimeout é¿å… UI å¡æ­»
    setTimeout(() => {
        analyzeJapanese(result.value);
    }, 100);
  } catch (err) {
    statusEl.textContent = 'âŒ æ–‡ä»¶è¯»å–å¤±è´¥';
  }
});

function analyzeJapanese(text) {
  const map = { åè¯:{}, åŠ¨è¯:{}, å½¢å®¹è¯:{} };
  const tokens = kuromojiTokenizer.tokenize(text);

  tokens.forEach(t => {
    let base = t.basic_form !== '*' ? t.basic_form : t.surface_form;
    let cat = null, sub = 'å…¶ä»–';

    if (t.pos === 'å‹•è©') {
      cat = 'åŠ¨è¯';
      if (t.conjugated_type?.includes('äº”æ®µ')) sub = 'ä¸€ç±»åŠ¨è¯ï¼ˆäº”æ®µï¼‰';
      else if (t.conjugated_type?.includes('ä¸€æ®µ')) sub = 'äºŒç±»åŠ¨è¯ï¼ˆä¸€æ®µï¼‰';
      else if (base === 'ã™ã‚‹') sub = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚µå˜ï¼‰';
      else if (base === 'æ¥ã‚‹') sub = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚«å˜ï¼‰';
    } else if (t.pos === 'åè©') {
      cat = 'åè¯';
      if (t.pos_detail_1 === 'æ•°') sub = 'é‡è¯';
      else if (/^[ã‚¡-ãƒ¶ãƒ¼]+$/.test(t.surface_form)) sub = 'å¤–æ¥è¯­';
      else sub = 'æ™®é€šåè¯';
    } else if (t.pos === 'å½¢å®¹è©') {
      cat = 'å½¢å®¹è¯';
      sub = 'ä¸€ç±»å½¢å®¹è¯';
    }

    if (!cat) return;
    map[cat][sub] ??= {};
    map[cat][sub][base] = (map[cat][sub][base] || 0) + 1;
  });

  render(map);
  statusEl.textContent = 'åˆ†æå®Œæˆï¼';
}

function render(map) {
  wordListEl.innerHTML = '';
  for (const [cat, subs] of Object.entries(map)) {
    const section = document.createElement('div');
    section.className = 'word-section';
    section.innerHTML = `<h3>${cat}</h3>`; // ä¿®å¤ï¼šæ·»åŠ äº†åå¼•å·
    
    for (const [sub, words] of Object.entries(subs)) {
      const subTitle = document.createElement('div');
      subTitle.className = 'sub-title';
      subTitle.textContent = sub;
      section.appendChild(subTitle);

      Object.entries(words).sort((a,b)=>b[1]-a[1]).forEach(([w,f])=>{
        const span = document.createElement('span');
        span.className = 'word-card';
        span.innerHTML = `${w} <span class="freq">(${f})</span>`; // ä¿®å¤ï¼šæ·»åŠ äº†åå¼•å·
        span.onclick = () => addVocab(w);
        section.appendChild(span);
      });
    }
    wordListEl.appendChild(section);
  }
}

function addVocab(word) {
  if (vocabSet.has(word)) return;
  vocabSet.add(word);
  const div = document.createElement('div');
  div.className = 'vocab-item';
  div.textContent = word;
  vocabBookEl.appendChild(div);
}
</script>
</body>
</html>
