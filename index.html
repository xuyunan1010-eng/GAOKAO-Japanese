<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ä¸»è‰²è°ƒä¸åŸºç¡€æ ·å¼ -->
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
      background: #ffffff;
      color: #222;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fbff;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      color: #2563eb;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      padding: 16px 24px;
    }
    .panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      padding: 16px;
    }
    .upload-area {
      border: 2px dashed #93c5fd;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      color: #2563eb;
      cursor: pointer;
    }
    .upload-area input {
      display: none;
    }
    .word-list {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }
    .word-card {
      padding: 8px 10px;
      border-radius: 8px;
      background: #f9fafb;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }
    .word-card:hover {
      background: #eff6ff;
    }
    .word-card .freq {
      font-size: 12px;
      color: #6b7280;
    }
    aside h3 {
      margin-top: 0;
      font-size: 16px;
      color: #2563eb;
    }
    .vocab-item {
      font-size: 14px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <header>
    <h1>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·</h1>
  </header>

  <main>
    <!-- ä¸»æ“ä½œåŒº -->
    <section class="panel">
      <label class="upload-area" for="fileInput">
        ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ—¥è¯­è¯•å·å›¾ç‰‡ / Word æ–‡æ¡£
      </label>
      <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.docx" style="display:none" />

      <div id="status" style="margin-top:12px;color:#6b7280"></div>

      <div class="word-list" id="wordList"></div>
    </section>

    <!-- å³ä¾§åŠŸèƒ½åŒº -->
    <aside class="panel">
      <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
      <div id="vocabBook"></div>
    </aside>
  </main>

  <!-- ç¬¬ä¸‰æ–¹åº“ï¼ˆçº¯å‰ç«¯ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const wordListEl = document.getElementById('wordList');
    const vocabBookEl = document.getElementById('vocabBook');

    const vocabSet = new Set();

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;

      statusEl.textContent = 'æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™â€¦';
      let text = '';

      if (file.type.includes('image')) {
        const result = await Tesseract.recognize(file, 'jpn');
        text = result.data.text;
      } else if (file.name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        text = result.value;
      }

      analyzeJapanese(text);
    });

    function analyzeJapanese(text) {
      kuromoji.builder({ dicPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/' })
        .build((err, tokenizer) => {
          if (err) {
            statusEl.textContent = 'åˆ†è¯å™¨åŠ è½½å¤±è´¥';
            return;
          }

          const tokens = tokenizer.tokenize(text);
          const map = {
            'åŠ¨è¯': {},
            'åè¯': {},
            'å½¢å®¹è¯': {}
          };

          tokens.forEach(t => {
            if (!t.pos) return;

            let category = null;
            let subCategory = null;
            let base = t.basic_form !== '*' ? t.basic_form : t.surface_form;

            // â€”â€” åŠ¨è¯ â€”â€”
            if (t.pos === 'å‹•è©') {
              category = 'åŠ¨è¯';
              if (t.conjugated_type?.includes('äº”æ®µ')) subCategory = 'ä¸€ç±»åŠ¨è¯ï¼ˆäº”æ®µï¼‰';
              else if (t.conjugated_type?.includes('ä¸€æ®µ')) subCategory = 'äºŒç±»åŠ¨è¯ï¼ˆä¸€æ®µï¼‰';
              else if (base === 'ã™ã‚‹') subCategory = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚µå˜ï¼‰';
              else if (base === 'æ¥ã‚‹') subCategory = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚«å˜ï¼‰';
              else subCategory = 'å…¶ä»–';
            }

            // â€”â€” åè¯ â€”â€”
            else if (t.pos === 'åè©') {
              category = 'åè¯';
              if (t.pos_detail_1 === 'æ•°') subCategory = 'é‡è¯';
              else if (/^[ã‚¡-ãƒ¶ãƒ¼]+$/.test(t.surface_form)) subCategory = 'ç‰‡å‡ååè¯';
              else if (['ä¸Š','ä¸‹','å‰','å¾Œ','ä¸­','å¤–','å³','å·¦','æ±','è¥¿','å—','åŒ—'].includes(base)) subCategory = 'æ–¹ä½åè¯';
              else if (t.pos_detail_1 === 'ä¸€èˆ¬') subCategory = 'æ™®é€šåè¯';
              else subCategory = 'å…¶ä»–';
            }

            // â€”â€” å½¢å®¹è¯ â€”â€”
            else if (t.pos === 'å½¢å®¹è©') {
              category = 'å½¢å®¹è¯';
              if (t.conjugated_type?.includes('å½¢å®¹è©ãƒ»ã‚¤')) subCategory = 'ä¸€ç±»å½¢å®¹è¯';
              else subCategory = 'äºŒç±»å½¢å®¹è¯';
            }

            if (!category) return;

            if (!map[category][subCategory]) map[category][subCategory] = {};
            map[category][subCategory][base] = (map[category][subCategory][base] || 0) + 1;
          });

          renderWordList(map);
          statusEl.textContent = `å…±è¯†åˆ« ${Object.keys(map).length} ä¸ªå•è¯`;
        });
    }

    function renderWordList(map) {
      wordListEl.innerHTML = '';

      Object.entries(map).forEach(([category, subMap]) => {
        const title = document.createElement('h3');
        title.textContent = category;
        title.style.marginTop = '16px';
        wordListEl.appendChild(title);

        Object.entries(subMap).forEach(([subCategory, words]) => {
          const sub = document.createElement('div');
          sub.style.fontSize = '14px';
          sub.style.margin = '8px 0';
          sub.innerHTML = `<strong>${subCategory}</strong>`;
          wordListEl.appendChild(sub);

          Object.entries(words)
            .sort((a,b)=>b[1]-a[1])
            .forEach(([word,freq])=>{
              const div = document.createElement('div');
              div.className = 'word-card';
              div.innerHTML = `<div>${word}</div><div class="freq">å‡ºç° ${freq} æ¬¡</div>`;
              div.onclick = () => toggleVocab(word);
              wordListEl.appendChild(div);
            });
        });
      });
    }</strong></div>
          <div class="freq">${category} / ${subCategory}</div>
          <div class="freq">å‡ºç° ${freq} æ¬¡</div>
        `;

        div.onclick = () => toggleVocab(word);
        wordListEl.appendChild(div);
      });
    }

    function toggleVocab(word) {
      if (vocabSet.has(word)) return;
      vocabSet.add(word);

      const div = document.createElement('div');
      div.className = 'vocab-item';
      div.textContent = word;
      vocabBookEl.appendChild(div);
    }
  </script>
</body>
</html>
