<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ—¥æœ¬èªè©¦é¨“èªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ«ğŸ”</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Hiragino Sans",sans-serif;
  background:#ffffff;
  color:#222;
}
header{
  padding:16px 24px;
  border-bottom:1px solid #e5e7eb;
  background:#f8fbff;
}
header h1{
  margin:0;
  font-size:20px;
  color:#2563eb;
}
main{
  display:grid;
  grid-template-columns:1fr 320px;
  gap:16px;
  padding:16px 24px;
}
.panel{
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.04);
  padding:16px;
}
.upload{
  border:2px dashed #93c5fd;
  border-radius:12px;
  padding:32px;
  text-align:center;
  cursor:pointer;
  color:#2563eb;
}
#fileInput{display:none}

/* loading bar */
#loader{
  height:3px;
  background:#e5e7eb;
  border-radius:2px;
  overflow:hidden;
  margin:12px 0;
  display:none;
}
#loader div{
  height:100%;
  width:0%;
  background:#2563eb;
  transition:width .4s ease;
}

.section h3{
  margin-top:20px;
  color:#1d4ed8;
}
.sub{
  margin:10px 0 4px;
  font-weight:bold;
  font-size:14px;
}
.word{
  display:inline-block;
  margin:4px;
  padding:6px 10px;
  border-radius:6px;
  background:#f9fafb;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
  cursor:pointer;
  font-size:14px;
}
.word:hover{background:#eff6ff}
.freq{
  font-size:12px;
  color:#6b7280;
}
aside h3{margin-top:0;color:#2563eb}
.vocab-item{
  font-size:14px;
  margin-bottom:6px;
}
</style>
</head>

<body>
<header>
  <h1>æ—¥æœ¬èªè©¦é¨“èªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ«ğŸ”</h1>
</header>

<main>
<section class="panel">
  <label class="upload" for="fileInput">ç‚¹å‡»ä¸Šä¼  Wordï¼ˆ.docxï¼‰æ—¥è¯­è¯•å·</label>
  <input id="fileInput" type="file" accept=".docx">

  <div id="loader"><div></div></div>
  <div id="status" style="color:#6b7280"></div>
  <div id="result"></div>
</section>

<aside class="panel">
  <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
  <div id="vocab"></div>
</aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const vocabEl = document.getElementById('vocab');
const loader = document.getElementById('loader');
const bar = loader.firstElementChild;

let tokenizer = null;
const vocabSet = new Set();

/* ---------- loading æ§åˆ¶ ---------- */
function show(step){
  loader.style.display='block';
  statusEl.textContent=step;
  if(step==='è¯»å–æ–‡ä»¶') bar.style.width='33%';
  if(step==='åˆ†ææ–‡æœ¬') bar.style.width='66%';
  if(step==='å®Œæˆ') bar.style.width='100%';
}
function hide(){
  setTimeout(()=>{ loader.style.display='none'; bar.style.width='0%' },600);
}

/* ---------- åˆå§‹åŒ– tokenizerï¼ˆåªä¸€æ¬¡ï¼‰ ---------- */
kuromoji.builder({
  dicPath:'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/'
}).build((err,t)=>{
  if(err){
    statusEl.textContent='åˆ†è¯å™¨åŠ è½½å¤±è´¥';
    return;
  }
  tokenizer=t;
  statusEl.textContent='å¼•æ“å·²å°±ç»ªï¼Œè¯·ä¸Šä¼ æ–‡ä»¶';
});

/* ---------- æ–‡ä»¶å¤„ç† ---------- */
fileInput.addEventListener('change',async()=>{
  const file=fileInput.files[0];
  if(!file||!tokenizer) return;

  show('è¯»å–æ–‡ä»¶');
  const buffer=await file.arrayBuffer();
  const {value:text}=await mammoth.extractRawText({arrayBuffer:buffer});

  show('åˆ†ææ–‡æœ¬');
  setTimeout(()=>analyze(text),50);
});

/* ---------- æ ¸å¿ƒåˆ†æ ---------- */
function analyze(text){
  const map={åè¯:{},åŠ¨è¯:{},å½¢å®¹è¯:{}};
  const tokens=tokenizer.tokenize(text);

  tokens.forEach(t=>{
    let cat=null,sub=null;
    const base=t.basic_form!=='*'?t.basic_form:t.surface_form;

    if(t.pos==='åè©'){
      cat='åè¯';
      if(t.pos_detail_1==='æ•°') sub='é‡è¯';
      else if(/^[ã‚¡-ãƒ¶ãƒ¼]+$/.test(t.surface_form)) sub='ç‰‡å‡ååè¯';
      else if(['ä¸Š','ä¸‹','å‰','å¾Œ','ä¸­','å¤–','å³','å·¦','æ±','è¥¿','å—','åŒ—'].includes(base)) sub='æ–¹ä½åè¯';
      else sub='æ™®é€šåè¯';
    }
    if(t.pos==='å‹•è©'){
      cat='åŠ¨è¯';
      if(t.conjugated_type?.includes('äº”æ®µ')) sub='ä¸€ç±»åŠ¨è¯ï¼ˆäº”æ®µï¼‰';
      else if(t.conjugated_type?.includes('ä¸€æ®µ')) sub='äºŒç±»åŠ¨è¯ï¼ˆä¸€æ®µï¼‰';
      else if(base==='ã™ã‚‹') sub='ä¸‰ç±»åŠ¨è¯ï¼ˆã‚µå˜ï¼‰';
      else if(base==='æ¥ã‚‹') sub='ä¸‰ç±»åŠ¨è¯ï¼ˆã‚«å˜ï¼‰';
      else sub='å…¶ä»–';
    }
    if(t.pos==='å½¢å®¹è©'){
      cat='å½¢å®¹è¯';
      sub='ä¸€ç±»å½¢å®¹è¯';
    }
    if(!cat) return;
    map[cat][sub]??={};
    map[cat][sub][base]=(map[cat][sub][base]||0)+1;
  });

  render(map);
  show('å®Œæˆ');
  statusEl.textContent='åˆ†æå®Œæˆï¼Œç‚¹å‡»å•è¯åŠ å…¥ç”Ÿè¯æœ¬';
  hide();
}

/* ---------- æ¸²æŸ“ ---------- */
function render(map){
  resultEl.innerHTML='';
  Object.entries(map).forEach(([cat,subs])=>{
    const sec=document.createElement('div');
    sec.className='section';
    sec.innerHTML=`<h3>${cat}</h3>`;
    resultEl.appendChild(sec);

    Object.entries(subs).forEach(([sub,words])=>{
      const st=document.createElement('div');
      st.className='sub';
      st.textContent=sub;
      sec.appendChild(st);

      Object.entries(words).sort((a,b)=>b[1]-a[1]).forEach(([w,f])=>{
        const span=document.createElement('span');
        span.className='word';
        span.innerHTML=`${w} <span class="freq">(${f})</span>`;
        span.onclick=()=>addVocab(w);
        sec.appendChild(span);
      });
    });
  });
}

/* ---------- ç”Ÿè¯æœ¬ ---------- */
function addVocab(word){
  if(vocabSet.has(word)) return;
  vocabSet.add(word);
  const d=document.createElement('div');
  d.className='vocab-item';
  d.textContent=word;
  vocabEl.appendChild(d);
}
</script>
</body>
</html>
