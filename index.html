<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>日语词频分析 - 最终兼容版</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; text-align: center; }
        #status { padding: 20px; margin: 20px auto; max-width: 600px; border-radius: 10px; font-weight: bold; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .loading { color: #f59e0b; border: 2px solid #f59e0b; }
        .ready { color: #10b981; border: 2px solid #10b981; }
        #main { display: none; }
        button { padding: 15px 30px; font-size: 16px; background: #2563eb; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="status" class="loading">正在下载远程词库 (约16MB)...<br>请保持网络通畅，不要刷新</div>

    <div id="main">
        <input type="file" id="input" accept=".docx" style="display:none">
        <button onclick="document.getElementById('input').click()">上传 Word 试卷</button>
        <div id="res" style="text-align: left; max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 10px;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>

    <script>
        const statusEl = document.getElementById('status');
        const mainEl = document.getElementById('main');
        let tokenizer = null;

        // 直接使用 CDN 路径，避免本地服务器报错
        kuromoji.builder({ 
            dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/" 
        }).build((err, _tokenizer) => {
            if (err) {
                statusEl.innerHTML = "❌ 加载失败，请检查网络或刷新重试<br><small>" + err + "</small>";
                return;
            }
            tokenizer = _tokenizer;
            statusEl.className = "ready";
            statusEl.textContent = "✅ 引擎准备就绪！";
            mainEl.style.display = "block";
        });

        document.getElementById('input').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusEl.textContent = "正在读取 Word...";
            const buffer = await file.arrayBuffer();
            const { value } = await mammoth.extractRawText({ arrayBuffer: buffer });
            
            statusEl.textContent = "正在提取日语单词...";
            // 异步处理，防止 UI 冻结
            setTimeout(() => {
                const tokens = tokenizer.tokenize(value);
                const result = {};
                tokens.forEach(t => {
                    if (['名詞','動詞','形容詞'].includes(t.pos)) {
                        const word = t.basic_form === '*' ? t.surface_form : t.basic_form;
                        result[word] = (result[word] || 0) + 1;
                    }
                });
                
                document.getElementById('res').innerHTML = "<h3>词频统计：</h3>" + 
                    Object.entries(result).sort((a,b)=>b[1]-a[1]).slice(0, 100)
                    .map(([w, f]) => `<span style="display:inline-block; margin:5px; padding:5px; background:#eee;">${w}(${f})</span>`).join('');
                statusEl.textContent = "✅ 分析完成！";
            }, 100);
        };
    </script>
</body>
</html>
