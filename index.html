<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ—¥æœ¬èªè©¦é¨“èªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ«ğŸ”</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f0f4f8;
            color: #333;
        }
        header {
            background: #2563eb;
            color: #fff;
            padding: 1rem 2rem;
        }
        main {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: auto;
        }
        .panel {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .upload-zone {
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
        }
        .upload-zone:hover {
            background: #eff6ff;
        }
        #status {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            background: #e0f2fe;
            color: #075985;
        }
        .word-tag {
            display: inline-block;
            background: #f1f5f9;
            padding: 6px 12px;
            margin: 4px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .word-tag:hover {
            background: #3b82f6;
            color: #fff;
        }
        .count {
            font-size: 11px;
            opacity: 0.6;
            margin-left: 4px;
        }
        h3 {
            border-left: 4px solid #3b82f6;
            padding-left: 10px;
            margin-top: 25px;
        }
        .vocab-item {
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        button {
            cursor: pointer;
        }
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

<header>
    <h1>æ—¥æœ¬èªè©¦é¨“èªå½™é »åº¦åˆ†æãƒ„ãƒ¼ãƒ« ğŸ”</h1>
</header>

<main>
    <section class="panel">
        <div id="status">ğŸ“˜ å¼•æ“å·²å°±ç»ªï¼Œè¯·ä¸Šä¼  Word è¯•å·</div>

        <label class="upload-zone" for="fileInput">
            <big>ğŸ“„ ç‚¹å‡»ä¸Šä¼  Wordï¼ˆ.docxï¼‰è¯•å·</big>
            <p style="color:#64748b;">è‡ªåŠ¨åˆ†è¯ Â· è¯é¢‘ç»Ÿè®¡ Â· åˆ†ç±»å±•ç¤º</p>
        </label>
        <input type="file" id="fileInput" accept=".docx" hidden>

        <div style="margin:15px 0;">
            <button id="exportExcel"
                    style="padding:8px 14px;border:none;
                           background:#10b981;color:#fff;
                           border-radius:6px;font-size:14px;">
                ğŸ“Š å¯¼å‡º Excel
            </button>
        </div>

        <div id="result"></div>
    </section>

    <aside class="panel">
        <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
        <div id="vocabList"></div>
        <button id="clearVocab"
                style="margin-top:15px;font-size:12px;
                       background:none;border:none;color:#94a3b8;">
            æ¸…ç©ºç”Ÿè¯æœ¬
        </button>
    </aside>
</main>

<!-- æ ¸å¿ƒä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    const fileInput = document.getElementById('fileInput');
    const resultEl = document.getElementById('result');
    const vocabListEl = document.getElementById('vocabList');
    const statusEl = document.getElementById('status');

    const vocabSet = new Set();
    let tokenizer = null;
    let latestAnalysisData = null;

    // åˆå§‹åŒ–åˆ†è¯å™¨ï¼ˆCDN ç‰ˆï¼Œä¸å¡ï¼‰
    kuromoji.builder({
        dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/"
    }).build((err, tk) => {
        if (err) {
            statusEl.textContent = "âŒ åˆ†è¯å¼•æ“åŠ è½½å¤±è´¥";
            console.error(err);
        } else {
            tokenizer = tk;
        }
    });

    fileInput.addEventListener('change', async e => {
        const file = e.target.files[0];
        if (!file || !tokenizer) return;

        statusEl.textContent = "ğŸ“„ æ­£åœ¨è§£ææ–‡æ¡£â€¦";

        const buffer = await file.arrayBuffer();
        const { value } = await mammoth.extractRawText({ arrayBuffer: buffer });

        statusEl.textContent = "ğŸ§  æ­£åœ¨è¿›è¡Œè¯é¢‘åˆ†æâ€¦";

        setTimeout(() => {
            const tokens = tokenizer.tokenize(value);
            analyze(tokens);
        }, 50);
    });

    function analyze(tokens) {
        const data = { åè¯: {}, åŠ¨è¯: {}, å½¢å®¹è¯: {} };

        tokens.forEach(t => {
            let cat = null;
            if (t.pos === 'åè©') cat = 'åè¯';
            if (t.pos === 'å‹•è©') cat = 'åŠ¨è¯';
            if (t.pos === 'å½¢å®¹è©') cat = 'å½¢å®¹è¯';
            if (!cat) return;

            const word = t.basic_form !== '*' ? t.basic_form : t.surface_form;
            if (word.length < 2 && !/[\u4e00-\u9fa5]/.test(word)) return;

            data[cat][word] = (data[cat][word] || 0) + 1;
        });

        latestAnalysisData = data;
        render(data);
        statusEl.textContent = "âœ… åˆ†æå®Œæˆï¼Œç‚¹å‡»å•è¯åŠ å…¥ç”Ÿè¯æœ¬";
    }

    function render(data) {
        resultEl.innerHTML = '';
        for (const cat in data) {
            const words = Object.entries(data[cat]).sort((a,b)=>b[1]-a[1]);
            if (!words.length) continue;

            const h3 = document.createElement('h3');
            h3.textContent = cat;
            resultEl.appendChild(h3);

            words.forEach(([w,c])=>{
                const span = document.createElement('span');
                span.className = 'word-tag';
                span.innerHTML = `${w}<span class="count">${c}</span>`;
                span.onclick = ()=>addVocab(w);
                resultEl.appendChild(span);
            });
        }
    }

    function addVocab(word) {
        if (vocabSet.has(word)) return;
        vocabSet.add(word);
        const div = document.createElement('div');
        div.className = 'vocab-item';
        div.textContent = 'â€¢ ' + word;
        vocabListEl.prepend(div);
    }

    document.getElementById('clearVocab').onclick = ()=>{
        vocabSet.clear();
        vocabListEl.innerHTML = '';
    };

    // Excel å¯¼å‡º
    document.getElementById('exportExcel').onclick = () => {
        if (!latestAnalysisData) {
            alert('è¯·å…ˆä¸Šä¼ å¹¶åˆ†æè¯•å·');
            return;
        }

        const rows = [['ä¸€çº§åˆ†ç±»','å•è¯','å‡ºç°æ¬¡æ•°']];

        for (const cat in latestAnalysisData) {
            Object.entries(latestAnalysisData[cat])
                .sort((a,b)=>b[1]-a[1])
                .forEach(([w,c])=>{
                    rows.push([cat,w,c]);
                });
        }

        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'è¯é¢‘ç»Ÿè®¡');
        XLSX.writeFile(wb, 'æ—¥è¯­è¯•å·è¯é¢‘ç»Ÿè®¡.xlsx');
    };
</script>

</body>
</html>
