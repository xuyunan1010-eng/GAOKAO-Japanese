<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ—¥è¯­è¯•å·å•è¯é¢‘ç‡æŸ¥è¯¢å·¥å…·</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans", "Noto Sans CJK SC", sans-serif;
      background: #ffffff;
      color: #222;
    }
    header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fbff;
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      color: #2563eb;
    }
    main {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 16px;
      padding: 16px 24px;
    }
    .panel {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      padding: 16px;
    }
    .upload-area {
      border: 2px dashed #93c5fd;
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      color: #2563eb;
      cursor: pointer;
    }
    .word-section h3 {
      margin-top: 20px;
      color: #1d4ed8;
    }
    .sub-title {
      margin: 12px 0 6px;
      font-weight: bold;
    }
    .word-card {
      display: inline-block;
      margin: 4px;
      padding: 6px 10px;
      background: #f9fafb;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      cursor: pointer;
      font-size: 14px;
    }
    .word-card:hover {
      background: #eff6ff;
    }
    .freq {
      font-size: 12px;
      color: #6b7280;
    }
    aside h3 {
      margin-top: 0;
      color: #2563eb;
    }
    .vocab-item {
      font-size: 14px;
      margin-bottom: 6px;
    }
  </style>
</head>

<body>
<header>
  <h1>æ—¥è¯­è¯•å·å•è¯æå–å·¥å…·ï¼ˆWord ç¨³å®šç‰ˆï¼‰</h1>
</header>

<main>
  <section class="panel">
    <label class="upload-area" for="fileInput">
      ç‚¹å‡»ä¸Šä¼  Wordï¼ˆ.docxï¼‰æ—¥è¯­è¯•å·
    </label>
    <input type="file" id="fileInput" accept=".docx" hidden />

    <div id="status" style="margin-top:10px;color:#6b7280"></div>
    <div id="wordList"></div>
  </section>

  <aside class="panel">
    <h3>ğŸ“˜ ç”Ÿè¯æœ¬</h3>
    <div id="vocabBook"></div>
  </aside>
</main>

<script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.21/mammoth.browser.min.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const statusEl = document.getElementById('status');
const wordListEl = document.getElementById('wordList');
const vocabBookEl = document.getElementById('vocabBook');
const vocabSet = new Set();

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  statusEl.textContent = 'æ­£åœ¨è§£æ Word æ–‡æ¡£â€¦';
  const buffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer: buffer });
  analyzeJapanese(result.value);
});

function analyzeJapanese(text) {
  kuromoji.builder({
    dicPath: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/'
  }).build((err, tokenizer) => {
    if (err) {
      statusEl.textContent = 'åˆ†è¯å™¨åŠ è½½å¤±è´¥';
      return;
    }

    const map = { åè¯:{}, åŠ¨è¯:{}, å½¢å®¹è¯:{} };
    const tokens = tokenizer.tokenize(text);

    tokens.forEach(t => {
      let base = t.basic_form !== '*' ? t.basic_form : t.surface_form;
      let cat = null, sub = null;

      if (t.pos === 'å‹•è©') {
        cat = 'åŠ¨è¯';
        if (t.conjugated_type?.includes('äº”æ®µ')) sub = 'ä¸€ç±»åŠ¨è¯ï¼ˆäº”æ®µï¼‰';
        else if (t.conjugated_type?.includes('ä¸€æ®µ')) sub = 'äºŒç±»åŠ¨è¯ï¼ˆä¸€æ®µï¼‰';
        else if (base === 'ã™ã‚‹') sub = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚µå˜ï¼‰';
        else if (base === 'æ¥ã‚‹') sub = 'ä¸‰ç±»åŠ¨è¯ï¼ˆã‚«å˜ï¼‰';
        else sub = 'å…¶ä»–';
      }

      else if (t.pos === 'åè©') {
        cat = 'åè¯';
        if (t.pos_detail_1 === 'æ•°') sub = 'é‡è¯';
        else if (/^[ã‚¡-ãƒ¶ãƒ¼]+$/.test(t.surface_form)) sub = 'ç‰‡å‡ååè¯';
        else if (['ä¸Š','ä¸‹','å‰','å¾Œ','ä¸­','å¤–','å³','å·¦','æ±','è¥¿','å—','åŒ—'].includes(base)) sub = 'æ–¹ä½åè¯';
        else if (t.pos_detail_1 === 'ä¸€èˆ¬') sub = 'æ™®é€šåè¯';
        else sub = 'å…¶ä»–';
      }

      else if (t.pos === 'å½¢å®¹è©') {
        cat = 'å½¢å®¹è¯';
        sub = 'ä¸€ç±»å½¢å®¹è¯';
      }

      if (!cat) return;
      map[cat][sub] ??= {};
      map[cat][sub][base] = (map[cat][sub][base] || 0) + 1;
    });

    render(map);
    statusEl.textContent = 'åˆ†æå®Œæˆ';
  });
}

function render(map) {
  wordListEl.innerHTML = '';
  for (const [cat, subs] of Object.entries(map)) {
    const section = document.createElement('div');
    section.className = 'word-section';
    section.innerHTML = `<h3>${cat}</h3>`;
    wordListEl.appendChild(section);

    for (const [sub, words] of Object.entries(subs)) {
      const subTitle = document.createElement('div');
      subTitle.className = 'sub-title';
      subTitle.textContent = sub;
      section.appendChild(subTitle);

      Object.entries(words).sort((a,b)=>b[1]-a[1]).forEach(([w,f])=>{
        const span = document.createElement('span');
        span.className = 'word-card';
        span.innerHTML = `${w} <span class="freq">(${f})</span>`;
        span.onclick = ()=>addVocab(w);
        section.appendChild(span);
      });
    }
  }
}

function addVocab(word) {
  if (vocabSet.has(word)) return;
  vocabSet.add(word);
  const div = document.createElement('div');
  div.className = 'vocab-item';
  div.textContent = word;
  vocabBookEl.appendChild(div);
}
</script>
</body>
</html>
